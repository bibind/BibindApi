# =====================================
# Variables et Fichiers Communes
# =====================================
DOCKER_COMPOSE=docker-compose
DOCKER_COMPOSE_FILES=$(DOCKER_COMPOSE).api.yml $(DOCKER_COMPOSE).hydra-kratos.yml $(DOCKER_COMPOSE).odoo.yml $(DOCKER_COMPOSE).gitlab.yml $(DOCKER_COMPOSE).awx.yml
mkfile_path := $(abspath $(lastword $(MAKEFILE_LIST)))
current_dir := $(notdir $(patsubst %/,%,$(dir $(mkfile_path))))
cur_dir=${shell pwd}
parent_dir=${shell dirname ${shell pwd}}
# Variables gÃ©nÃ©riques d'environnement
BACKEND_IMAGE=bindingapi-backend
FRONTEND_IMAGE=bindingapi-frontend

.PHONY: up-api up-hydra-kratos up-odoo up-awx up-gitlab up-all \
        down-api down-hydra-kratos down-odoo down-awx down-gitlab down-all \
        build-api build-hydra-kratos build-odoo build-awx build-gitlab build-all \
        start-api-hydra restart-api test backend-shell help clean

# =====================================
# 1. Lancement/ArrÃªt des Services
# =====================================

# Lancer BibindAPI seul
up-api:
	@echo "ğŸš€ Lancement de BibindAPI (backend + database)..."
	docker-compose -f $(DOCKER_COMPOSE).api.yml up -d

# Lancer Hydra + Kratos
up-hydra-kratos:
	@echo "ğŸš€ Lancement de Hydra et Kratos (authentification)..."
	docker-compose -f $(DOCKER_COMPOSE).hydra-kratos.yml up -d

# Lancer Odoo
up-odoo:
	@echo "ğŸš€ Lancement de Odoo..."
	docker-compose -f $(DOCKER_COMPOSE).odoo.yml up -d

# Lancer GitLab
up-gitlab:
	@echo "ğŸš€ Lancement de GitLab..."
	docker-compose -f $(DOCKER_COMPOSE).gitlab.yml up -d

# Lancer AWX
up-awx:
	@echo "ğŸš€ Lancement de AWX..."
	docker-compose -f $(DOCKER_COMPOSE).awx.yml up -d

# Lancer tous les services
up-all: up-api up-hydra-kratos up-odoo up-gitlab up-awx
	@echo "ğŸš€ Tous les services sont dÃ©marrÃ©s."

# ArrÃªter BibindAPI
down-api:
	@echo "ğŸ›‘ ArrÃªt de BibindAPI..."
	docker-compose -f $(DOCKER_COMPOSE).api.yml down

# ArrÃªter Hydra + Kratos
down-hydra-kratos:
	@echo "ğŸ›‘ ArrÃªt de Hydra et Kratos..."
	docker-compose -f $(DOCKER_COMPOSE).hydra-kratos.yml down

# ArrÃªter Odoo
down-odoo:
	@echo "ğŸ›‘ ArrÃªt de Odoo..."
	docker-compose -f $(DOCKER_COMPOSE).odoo.yml down

# ArrÃªter GitLab
down-gitlab:
	@echo "ğŸ›‘ ArrÃªt de GitLab..."
	docker-compose -f $(DOCKER_COMPOSE).gitlab.yml down

# ArrÃªter AWX
down-awx:
	@echo "ğŸ›‘ ArrÃªt de AWX..."
	docker-compose -f $(DOCKER_COMPOSE).awx.yml down

# ArrÃªter tous les services
down-all: down-api down-hydra-kratos down-odoo down-gitlab down-awx
	@echo "ğŸ›‘ Tous les services sont arrÃªtÃ©s."

# RedÃ©marrer BibindAPI et Hydra/Kratos pour les tests d'authentification
restart-api:
	@echo "ğŸ”„ RedÃ©marrage de BibindAPI et Hydra/Kratos..."
	$(MAKE) down-api down-hydra-kratos
	$(MAKE) up-api up-hydra-kratos

# =====================================
# 2. Build des Services Docker
# =====================================

# Construire l'image Docker pour BibindAPI
build-api:
	@echo "ğŸ”¨ Construction des images pour BibindAPI..."
	docker-compose -f $(DOCKER_COMPOSE).api.yml --env-file $(parent_dir)/api/.env build

# Construire Hydra et Kratos
build-hydra-kratos:
	@echo "ğŸ”¨ Construction des images pour Hydra et Kratos..."
	docker-compose -f $(DOCKER_COMPOSE).hydra-kratos.yml build

# Construire Odoo
build-odoo:
	@echo "ğŸ”¨ Construction de l'image Odoo..."
	docker-compose -f $(DOCKER_COMPOSE).odoo.yml build

# Construire GitLab
build-gitlab:
	@echo "ğŸ”¨ Construction des images GitLab..."
	docker-compose -f $(DOCKER_COMPOSE).gitlab.yml build

# Construire AWX
build-awx:
	@echo "ğŸ”¨ Construction des images AWX..."
	docker-compose -f $(DOCKER_COMPOSE).awx.yml build

# Construire toutes les images Docker
build-all: build-api build-hydra-kratos build-odoo build-gitlab build-awx
	@echo "âœ… Toutes les images Docker ont Ã©tÃ© construites avec succÃ¨s."

# =====================================
# 3. Tests et Debug
# =====================================

# ExÃ©cuter les tests unitaires sur BibindAPI
test:
	@echo "âš™ï¸ ExÃ©cution des tests unitaires sur BibindAPI..."
	docker-compose -f $(DOCKER_COMPOSE).api.yml run --rm api pytest tests/

# Shell dans le conteneur backend pour debug
backend-shell:
	@echo "ğŸ’» Connexion au conteneur backend pour debug..."
	docker exec -it $(BACKEND_IMAGE) /bin/sh || { echo "âŒ Impossible d'ouvrir une session dans le conteneur backend."; exit 1; }

# =====================================
# 4. Nettoyage
# =====================================

clean: down-all
	@echo "ğŸ§¹ Suppression des volumes Docker persistants..."
	docker volume prune -f

# =====================================
# 5. Aide
# =====================================

help:
	@echo "ğŸ“œ Liste des commandes Makefile disponibles :"
	@echo ""
	@echo "Lancement des services :"
	@echo "  up-api               - Lance BibindAPI (backend + database)."
	@echo "  up-hydra-kratos      - Lance Hydra et Kratos."
	@echo "  up-odoo              - Lance Odoo."
	@echo "  up-gitlab            - Lance GitLab."
	@echo "  up-awx               - Lance AWX."
	@echo "  up-all               - Lance tous les services."
	@echo ""
	@echo "ArrÃªt des services :"
	@echo "  down-api             - ArrÃªte BibindAPI."
	@echo "  down-hydra-kratos    - ArrÃªte Hydra et Kratos."
	@echo "  down-odoo            - ArrÃªte Odoo."
	@echo "  down-gitlab          - ArrÃªte GitLab."
	@echo "  down-awx             - ArrÃªte AWX."
	@echo "  down-all             - ArrÃªte tous les services."
	@echo ""
	@echo "Build des services :"
	@echo "  build-api            - Construit les images pour BibindAPI."
	@echo "  build-hydra-kratos   - Construit les images pour Hydra/Kratos."
	@echo "  build-odoo           - Construit les images pour Odoo."
	@echo "  build-gitlab         - Construit les images pour GitLab."
	@echo "  build-awx            - Construit les images pour AWX."
	@echo "  build-all            - Construit toutes les images."
	@echo ""
	@echo "Autres :"
	@echo "  restart-api          - RedÃ©marre BibindAPI et Hydra/Kratos."
	@echo "  clean                - Supprime tous les volumes persistants."
	@echo "  backend-shell        - Ouvre une session shell dans le conteneur backend."
	@echo "  test                 - ExÃ©cute les tests unitaires sur BibindAPI."
	@echo "  help                 - Affiche cette aide."